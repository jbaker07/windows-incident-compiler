name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy (core)
        run: cargo clippy --workspace --all-targets -- -D warnings
      
      - name: Run clippy (pro)
        run: cargo clippy --workspace --all-targets --features pro -- -D warnings
      
      - name: Build release (core)
        run: cargo build --release --workspace
      
      - name: Build release (pro)
        run: cargo build --release --workspace --features pro
      
      - name: Run tests (core)
        run: cargo test --workspace
      
      - name: Run tests (pro)
        run: cargo test --workspace --features pro
      
  # Optional: Linux build for cross-platform validation
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build (Linux crates only)
        run: cargo build --release -p edr-core -p edr-locald -p workbench
      
      - name: Run tests (Linux crates)
        run: cargo test -p edr-core -p edr-locald -p workbench

  # Security: Verify binaries don't contain sensitive material
  security-scan:
    name: Security Scan
    runs-on: windows-latest
    needs: build-and-test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release binaries
        run: cargo build --workspace --release
      
      - name: Scan binaries for sensitive strings
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $SHIPPING_BINARIES = @(
            "target/release/edr-server.exe",
            "target/release/edr-locald.exe",
            "target/release/capture_windows_rotating.exe"
          )
          
          # Patterns that should NEVER appear in shipping binaries
          $FORBIDDEN_PATTERNS = @(
            "SigningKey",
            "PRIVATE_KEY",
            "EDR_LICENSE_PRIVATE_KEY",
            "-----BEGIN PRIVATE KEY-----",
            "ed25519_secret"
          )
          
          Write-Host "=== Security Scan: Checking binaries for sensitive strings ==="
          $violations = @()
          
          foreach ($bin in $SHIPPING_BINARIES) {
            if (!(Test-Path $bin)) {
              Write-Host "  ⚠ Skipping (not found): $bin"
              continue
            }
            
            Write-Host "  Scanning: $bin"
            $content = [System.IO.File]::ReadAllText($bin, [System.Text.Encoding]::ASCII)
            
            foreach ($pattern in $FORBIDDEN_PATTERNS) {
              if ($content -match $pattern) {
                $violations += "VIOLATION: Found '$pattern' in $bin"
                Write-Host "    ✗ Found forbidden pattern: $pattern" -ForegroundColor Red
              }
            }
          }
          
          if ($violations.Count -gt 0) {
            Write-Host ""
            Write-Host "=== SECURITY VIOLATIONS ===" -ForegroundColor Red
            $violations | ForEach-Object { Write-Host $_ -ForegroundColor Red }
            exit 1
          }
          
          Write-Host ""
          Write-Host "✓ Security scan passed - no sensitive strings found" -ForegroundColor Green

  # Verify artifact allowlist
  artifact-allowlist:
    name: Verify Artifact Allowlist
    runs-on: windows-latest
    needs: build-and-test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build release binaries
        run: cargo build --workspace --release
      
      - name: Verify artifact allowlist
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          # Load canonical allowlist (single source of truth)
          $allowlistPath = Join-Path $PWD "packaging" "allowlist.json"
          if (-not (Test-Path $allowlistPath)) {
            Write-Error "FATAL: packaging/allowlist.json not found!"
            exit 1
          }
          $allowlist = Get-Content $allowlistPath | ConvertFrom-Json
          
          $ALLOWED_BINARIES = $allowlist.allowed_binaries
          $FORBIDDEN_BINARIES = $allowlist.forbidden_binaries
          
          Write-Host "=== Artifact Allowlist Verification ==="
          Write-Host "Source: packaging/allowlist.json"
          Write-Host ""
          
          # Check allowed binaries exist
          Write-Host "Checking required binaries..."
          foreach ($bin in $ALLOWED_BINARIES) {
            $path = Join-Path "target/release" $bin
            if (Test-Path $path) {
              Write-Host "  ✓ Found: $bin" -ForegroundColor Green
            } else {
              Write-Host "  ✗ MISSING: $bin" -ForegroundColor Red
              exit 1
            }
          }
          
          # Check forbidden binaries exist (should be built but NOT shipped)
          Write-Host ""
          Write-Host "Verifying forbidden binaries exist (to ensure we'd catch them if shipped)..."
          foreach ($forbidden in $FORBIDDEN_BINARIES) {
            $path = Join-Path "target/release" $forbidden
            if (Test-Path $path) {
              Write-Host "  ⚠ Built (correctly excluded from shipping): $forbidden" -ForegroundColor Yellow
            }
          }
          
          # Special check: license_gen MUST be built (it's the vendor tool)
          $licenseGenPath = Join-Path "target/release" "license_gen.exe"
          if (!(Test-Path $licenseGenPath)) {
            Write-Host ""
            Write-Host "✗ WARNING: license_gen.exe not built - vendor tool missing" -ForegroundColor Yellow
          }
          
          Write-Host ""
          Write-Host "✓ Artifact allowlist verification passed" -ForegroundColor Green
