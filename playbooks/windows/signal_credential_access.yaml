---
# playbooks/windows/signal_credential_access.yaml
# Detection of credential access attempts

id: "windows_credential_access_001"
title: "Credential Access Detection"
name: "Credential Access Detection"
family: "credential_access"
version: "2.0"
description: |
  Detects credential access attempts including:
  - LSASS memory access (mimikatz-like)
  - SAM database access
  - Credential dumping tools
  - NTDS.dit access

enabled: true
confidence_threshold: 0.90

requires:
  - security_log

enhances_with:
  - sysmon

mitre:
  tactics:
    - credential_access
  techniques:
    - T1003.001  # LSASS Memory
    - T1003.002  # SAM
    - T1003.003  # NTDS

input_facts:
  required:
    - Exec
  optional:
    - MemAlloc

slots:
  optional:
    - name: lsass_target
      type: string
      pattern: "(?i)lsass"
    - name: sam_access
      type: string
      pattern: "(?i)sam|security|system"

rules:
  - name: "LSASS Memory Dump Tool"
    window: 10
    conditions:
      - fact_type: Exec
      - field: cmdline
        matches: "(?i)(procdump|mimikatz|sekurlsa|logonpasswords|lsadump)"
    actions:
      - severity: CRITICAL
        tags:
          - "credential_dump"
          - "lsass"
          - "mimikatz"
    evidence:
      - event_type: "process_creation"
        event_id: [4688, 1]

  - name: "SAM Registry Export"
    window: 10
    conditions:
      - fact_type: Exec
      - field: cmdline
        matches: "(?i)reg.*(save|export).*(sam|security|system)"
    actions:
      - severity: CRITICAL
        tags:
          - "sam_export"
          - "offline_attack"

  - name: "Shadow Copy NTDS Access"
    window: 60
    conditions:
      - fact_type: Exec
      - field: cmdline
        matches: "(?i)ntds\\.dit|vssadmin.*create\\s+shadow"
    actions:
      - severity: CRITICAL
        tags:
          - "ntds_theft"
          - "domain_compromise"

  - name: "Comsvcs LSASS Dump"
    window: 10
    conditions:
      - fact_type: Exec
      - field: cmdline
        matches: "(?i)rundll32.*comsvcs.*(minidump|#24).*lsass"
    actions:
      - severity: CRITICAL
        tags:
          - "lsass_dump"
          - "lolbin"

  - name: "Credential Manager Query"
    window: 60
    aggregation: count
    threshold: 3
    conditions:
      - fact_type: Exec
      - field: cmdline
        matches: "(?i)cmdkey|vaultcmd"
    actions:
      - severity: MEDIUM
        tags:
          - "credential_enum"

response:
  - type: "alert"
    channel: "siem"
    title: "Credential Access Attempt"
    priority: "critical"

false_positives:
  - "Legitimate admin backup of SAM"
  - "Authorized penetration testing"
