---
# playbooks/windows/signal_wscript_cscript_abuse.yaml
# Detection of WScript/CScript abuse for script execution

id: "windows_script_host_abuse_001"
title: "Windows Script Host Abuse"
name: "WScript/CScript Detection"
family: "execution"
version: "2.0"
description: |
  Detects abuse of Windows Script Host (wscript/cscript) for:
  - VBScript/JScript execution
  - Script-based dropper execution
  - Office macro spawned scripts

enabled: true
confidence_threshold: 0.75

requires:
  - security_log
  - audit_proc_creation

mitre:
  tactics:
    - execution
    - defense_evasion
  techniques:
    - T1059.005  # VBScript
    - T1059.007  # JavaScript

input_facts:
  required:
    - Exec

rules:
  - name: "Script Host from Office"
    window: 60
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)(wscript|cscript)\\.exe"
      - field: parent_cmdline
        matches: "(?i)(winword|excel|powerpnt|outlook)\\.exe"
    actions:
      - severity: CRITICAL
        tags:
          - "macro_execution"
          - "office_spawn"
          - "initial_access"
    evidence:
      - event_type: "process_creation"
        event_id: [4688, 1]

  - name: "Script from Temp Directory"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)(wscript|cscript)\\.exe"
      - field: cmdline
        matches: "(?i)(\\\\temp\\\\|%temp%|\\\\appdata\\\\).*\\.(vbs|js|wsf)"
    actions:
      - severity: HIGH
        tags:
          - "suspicious_location"
          - "dropper"

  - name: "Script with Download Content"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)(wscript|cscript)\\.exe"
      # Can't see script content from cmdline, but track for correlation
    actions:
      - severity: MEDIUM
        tags:
          - "script_execution"

  - name: "Script Engine Spawns PowerShell"
    window: 60
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)powershell"
      - field: parent_cmdline
        matches: "(?i)(wscript|cscript)\\.exe"
    actions:
      - severity: HIGH
        tags:
          - "script_chain"
          - "multi_stage"

response:
  - type: "alert"
    channel: "siem"
    title: "Script Host Abuse Detected"
    priority: "high"

false_positives:
  - "Legitimate login scripts"
  - "IT automation VBScripts"
