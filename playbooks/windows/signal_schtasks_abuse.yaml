---
# playbooks/windows/signal_schtasks_abuse.yaml
# Detection of schtasks.exe abuse for persistence

id: "windows_schtasks_abuse_001"
title: "Schtasks Persistence Abuse"
name: "Schtasks Abuse Detection"
family: "persistence"
version: "2.0"
description: |
  Detects abuse of schtasks.exe for:
  - Task creation for persistence
  - Remote task creation (lateral movement)
  - SYSTEM privilege escalation
  - Hidden task scheduling

enabled: true
confidence_threshold: 0.75

requires:
  - security_log
  - audit_proc_creation

mitre:
  tactics:
    - persistence
    - execution
    - privilege_escalation
  techniques:
    - T1053.005  # Scheduled Task

input_facts:
  required:
    - Exec
  optional:
    - PersistArtifact

slots:
  required:
    - name: process_name
      type: string
      pattern: "(?i)schtasks\\.exe"
  optional:
    - name: create_flag
      type: string
      pattern: "(?i)/create"
    - name: run_as_system
      type: string
      pattern: "(?i)/ru\\s+(system|\"system\")"
    - name: remote_target
      type: string
      pattern: "(?i)/s\\s+\\\\\\\\|/s\\s+[a-zA-Z0-9]"

rules:
  - name: "Task Created with SYSTEM Privilege"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)schtasks"
      - field: cmdline
        matches: "(?i)/create.*/ru\\s+(system|\"system\")"
    actions:
      - severity: HIGH
        tags:
          - "persistence"
          - "privilege_escalation"
          - "system_task"
    evidence:
      - event_type: "process_creation"
        event_id: [4688, 1]

  - name: "Remote Task Creation"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)schtasks"
      - field: cmdline
        matches: "(?i)/create.*/s\\s+"
    actions:
      - severity: CRITICAL
        tags:
          - "lateral_movement"
          - "remote_task"

  - name: "Task with Hidden Attribute"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)schtasks"
      - field: cmdline
        matches: "(?i)/create.*/v1"  # V1 allows hiding
    actions:
      - severity: HIGH
        tags:
          - "hidden_task"
          - "evasion"

  - name: "Task Running PowerShell"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)schtasks"
      - field: cmdline
        matches: "(?i)/create.*/tr\\s+.*powershell"
    actions:
      - severity: HIGH
        tags:
          - "powershell_persistence"
          - "scheduled_task"

  - name: "Task Running from Temp"
    window: 10
    conditions:
      - fact_type: Exec
      - field: path
        matches: "(?i)schtasks"
      - field: cmdline
        matches: "(?i)/create.*/tr\\s+.*(\\\\temp\\\\|%temp%|\\\\appdata\\\\)"
    actions:
      - severity: CRITICAL
        tags:
          - "suspicious_location"
          - "malware_persistence"

response:
  - type: "alert"
    channel: "siem"
    title: "Schtasks Abuse Detected"
    priority: "high"

false_positives:
  - "IT deployment scripts creating legitimate tasks"
  - "Backup software scheduling operations"
