id: import-yara-malware-detection
name: YARA Malware Detection Summary
version: "1.0.0"
description: >
  Aggregates YARA scan results into malware detection signals with
  severity based on rule categories and match counts.

trigger:
  required_events:
    - type: yara_match
      source_adapter: yara
      min_count: 1

correlation:
  # Group by target file
  group_by:
    - fields: [target_file]
  time_window: 1h
  
  aggregate:
    rule_count: "count_distinct(rule)"
    match_count: "count(*)"

signal_template:
  title: "Malware Detected: {{target_file | basename}}"
  severity: medium
  confidence: high
  
  severity_modifiers:
    # High-severity rule categories
    - condition: "has_apt_rule"
      bump: critical
    - condition: "has_ransomware_rule"
      bump: critical
    - condition: "has_c2_rule"
      bump: high
    - condition: "rule_count >= 3"
      bump: +1
    - condition: "has_webshell_rule"
      bump: high
      
  fields:
    target_file: "{{group.target_file}}"
    target_basename: "{{target_file | basename}}"
    rule_count: "{{rule_count}}"
    match_count: "{{match_count}}"
    
    # Extract rule information
    rules: "{{events | map: 'rule' | unique}}"
    rule_tags: "{{events | flat_map: 'rule_tags' | unique}}"
    namespaces: "{{events | map: 'namespace' | unique | reject: 'default'}}"
    
    # Categorization
    has_apt_rule: "{{rules | select: 'matches', '(?i)apt|cve|0day' | size | gt: 0}}"
    has_ransomware_rule: "{{rules | select: 'matches', '(?i)ransom|locker|encrypt' | size | gt: 0}}"
    has_c2_rule: "{{rules | select: 'matches', '(?i)cobalt|beacon|c2|rat' | size | gt: 0}}"
    has_webshell_rule: "{{rules | select: 'matches', '(?i)webshell|jsp|aspx' | size | gt: 0}}"
    has_miner_rule: "{{rules | select: 'matches', '(?i)miner|crypto|xmr' | size | gt: 0}}"
    
    # Metadata extraction (if present)
    malware_families: "{{events | flat_map: 'metadata.malware_family' | unique | reject: nil}}"
    threat_actors: "{{events | flat_map: 'metadata.actor' | unique | reject: nil}}"
    
  explanation:
    summary: >
      YARA scan detected {{rule_count}} malicious pattern(s) in {{target_basename}}.
      
      Matching rules: {{rules | join: ', '}}
      
      {% if malware_families | size > 0 %}
      Identified malware families: {{malware_families | join: ', '}}
      {% endif %}
      
      {% if has_apt_rule %}
      ⚠️ APT/Advanced threat indicators matched - high priority investigation required.
      {% endif %}
      {% if has_ransomware_rule %}
      ⚠️ RANSOMWARE indicators detected - immediate containment recommended.
      {% endif %}
      {% if has_c2_rule %}
      ⚠️ Command & Control framework signatures matched.
      {% endif %}
      
    recommendations:
      - "Isolate affected system from network"
      - "Preserve evidence: {{target_file}}"
      - "Check for lateral movement from this host"
      - "Review process execution history"
      
    evidence_refs:
      - "YARA results: {{events | first | get: 'evidence_ptr'}}"
      - "Rules matched: {{rules | size}}"

  tags:
    - malware
    - yara
    - detection
    - import_signal
    - "{{has_apt_rule | then: 'apt'}}"
    - "{{has_ransomware_rule | then: 'ransomware'}}"
    - "{{has_c2_rule | then: 'c2'}}"

metadata:
  author: import-system
  mitre_attack:
    - T1059      # Command and Scripting Interpreter
    - T1105      # Ingress Tool Transfer
    - T1204      # User Execution
