id: import-web-vulnerability-summary
name: Web Vulnerability Summary
version: "1.0.0"
description: >
  Aggregates web application security scan results from OWASP ZAP, HAR analysis,
  and Suricata HTTP events into prioritized vulnerability signals.

trigger:
  required_events:
    - type: web_vulnerability
      source_adapter: [zap, burp]
      min_count: 1
  optional_events:
    - type: http_txn
      source_adapter: [suricata, har]

correlation:
  # Group by site/host
  group_by:
    - fields: [host, site]
  time_window: 24h
  
  aggregate:
    high_risk_count: "count_where(risk_level == 'High')"
    medium_risk_count: "count_where(risk_level == 'Medium')"
    low_risk_count: "count_where(risk_level == 'Low')"
    total_findings: "count(*)"

signal_template:
  title: "Web Vulnerabilities: {{target_site}}"
  
  severity: >
    {% if high_risk_count >= 1 %}high
    {% elsif medium_risk_count >= 3 %}medium
    {% else %}low
    {% endif %}
    
  confidence: high
  
  severity_modifiers:
    - condition: "has_critical_vuln"
      bump: critical
    - condition: "high_risk_count >= 3"
      bump: +1
    - condition: "has_injection"
      bump: high
      
  fields:
    target_site: "{{group.host | default: group.site}}"
    high_risk_count: "{{high_risk_count}}"
    medium_risk_count: "{{medium_risk_count}}"
    low_risk_count: "{{low_risk_count}}"
    total_findings: "{{total_findings}}"
    
    # Vulnerability breakdown
    vuln_types: "{{events | where: 'event_type', 'web_vulnerability' | map: 'alert_name' | unique}}"
    cwe_ids: "{{events | map: 'cwe_id' | unique | reject: '' | reject: 'CWE-0'}}"
    
    # High-priority detections
    high_risk_vulns: "{{events | where: 'risk_level', 'High' | map: 'alert_name' | unique}}"
    
    # Critical vulnerability types
    has_critical_vuln: "{{vuln_types | select: 'matches', '(?i)remote.*code|rce|deserialization|xxe' | size | gt: 0}}"
    has_injection: "{{vuln_types | select: 'matches', '(?i)sql.*inject|command.*inject|ldap.*inject' | size | gt: 0}}"
    has_xss: "{{vuln_types | select: 'matches', '(?i)xss|cross.site.script' | size | gt: 0}}"
    has_auth_issue: "{{vuln_types | select: 'matches', '(?i)auth|session|csrf' | size | gt: 0}}"
    
    # Affected URLs
    affected_urls: "{{events | flat_map: 'instances' | map: 'uri' | unique | first: 20}}"
    affected_url_count: "{{affected_urls | size}}"
    
  explanation:
    summary: >
      Web application security scan of {{target_site}} identified:
      - {{high_risk_count}} high-risk finding(s)
      - {{medium_risk_count}} medium-risk finding(s)  
      - {{low_risk_count}} low-risk finding(s)
      
      {% if has_critical_vuln %}
      ⚠️ CRITICAL: Remote code execution or deserialization vulnerabilities detected.
      {% endif %}
      {% if has_injection %}
      ⚠️ Injection vulnerabilities present - SQL, command, or LDAP injection.
      {% endif %}
      
      High-risk vulnerabilities: {{high_risk_vulns | join: ', '}}
      
    recommendations:
      - "Prioritize patching high-risk findings immediately"
      - "Review affected endpoints: {{affected_urls | first: 3 | join: ', '}}"
      - "Enable WAF rules for detected vulnerability classes"
      - "Schedule penetration test to validate findings"
      
    evidence_refs:
      - "Scan report: {{events | first | get: 'evidence_ptr'}}"
      - "{{total_findings}} total findings from scan"

  tags:
    - web
    - vulnerability
    - appsec
    - zap
    - import_signal
    - "{{has_injection | then: 'injection'}}"
    - "{{has_xss | then: 'xss'}}"

metadata:
  author: import-system
  mitre_attack:
    - T1190      # Exploit Public-Facing Application
    - T1059      # Command and Scripting Interpreter
